{% extends "base.html" %}

{% block body %}

{% if admin %}
<form action="{{ url_for('buscador', user='admin') }}" method="post" accept-charset="utf-8">
  <input id="buscador" name="buscador" placeholder="Busca telèfon o nom">
  <br>
  <input class="btn" type="submit" value="Buscar">
</form>
{% else %}
<form action="{{ url_for('buscador', user='main') }}" method="post" accept-charset="utf-8">
  <input id="buscador" name="buscador" placeholder="Busca telèfon o nom">
  <br>
  <input class="btn" type="submit" value="Buscar">
</form>
{% endif %}

<br>

{% if resultDict %}
<table style="width:100%">
  <tr>
    <th>Telèfon</th>
    <th>Nom</th>
    {% if admin %}<th>Delete</th>{% endif %}
  </tr>
  {% for contacte in resultDict %}
  <tr>
    <td>{{ contacte.tlf }}</td>
    <td>{{ contacte.nom }}</td>
    {% if admin %}
    <td>
      <input class="btn" type="submit" id="btn-{{ contacte.tlf }}"
	     data-tlf="{{ contacte.tlf }}"
	     data-nom="{{ contacte.nom }}"
	     value="ESBORRAR"
	     style="color: white; background: #990000; font-weight: bold;"
	     onclick="submitForm('{{ contacte.tlf }}')">
    </td>
    {% endif %}
  </tr>
  {% endfor %}
</table>
{% endif %}

<br>

{% if admin %}
<div id="accordion">
  
  {% if resultDict %}
  <h3>Modifica el contacte</h3>
  <div>
    <form action="{{ url_for('tlf.update') }}" method="post" accept-charset="utf-8">
      <input name="old_tlf" placeholder="Telèfon del contacte a modificar">
      <input name="nou_tlf" placeholder="Nou telèfon">
      <input name="nou_nom" placeholder="Nou nom">
      <br>
      <input class="btn" type="submit" value="Modificar">
    </form>
  </div>
  {% endif %}

  <h3>Afegeix un nou contacte</h3>
  <div>
    <form action="{{ url_for('tlf.insert') }}" method="post" accept-charset="utf-8">
      <input type="text" placeholder="Telèfon (màx. 9 caràcters)" name="tlf">
      <input type="text" placeholder="Nom" name="nom">
      <br><br>
      <input class="btn" type="submit" value="Afegir">
    </form>
  </div>
</div>

<br>

<form action="{{ url_for('tlf.get') }}" method="get">
  <input class="btn" type="submit" value="Exportar CSV">
</form>
<br>
<form action="{{ url_for('tlf.upload') }}" method="post" enctype="multipart/form-data">
  <input type="file" name="file">
  <input class="btn" type="submit" value="Upload">
</form>
{% endif %}

<script>
  function submitForm(tlf)
  {
    var http = new XMLHttpRequest();
    var btn = document.getElementById('btn-'+tlf);
    var nom = btn.getAttribute("data-nom");
    
    if (btn.value == "ESBORRAR")
    {
	http.open("POST", "{{ url_for('tlf.delete') }}", true);
	http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	var params = "delete_tlf=" + tlf;
	http.send(params);
	
	http.onload = function()
	{
	    btn.style.background = "#008b8b";
	    btn.value = "DESFER";
	}
    }
    else if (btn.value == "DESFER")
    {
	http.open("POST", "{{ url_for('tlf.insert') }}", true);
	http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	var params = "tlf=" + tlf + "&" + "nom=" + nom;
	http.send(params);
	http.onload = function()
	{
	    btn.style.background = "#990000";
	    btn.value = "ESBORRAR";
	}
    }	
}

$( function() {
    $( "#accordion" ).accordion({
	collapsible: true,
	active: 0
    });
} );

$(document).ready(function() {
    $.ajax({
	url: '{{ url_for("autocomplete") }}'
    }).done(function (data) {
	$('#buscador').autocomplete({
	    source: data.json_list,
	    minLength: 2
	});
    });
});
</script>

{% endblock %}
